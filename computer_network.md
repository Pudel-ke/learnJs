# 计算机网络

### 互联网是什么？

服务的角度来看

- 分布式应用进程
- 为分布式进程提供通信服务的基础设施

> 基础设施包括应用层以下的所有协议实体。(传输层、网络层、链路层、物理层，不包括应用)

组成的角度来看

- 网络边缘

> 主机系统(PC，Smartphone，pad)
>
> 应用程序(服务端程序、应用端程序)

- 网络核心(进行全球范围内端到端的数据交换)

> 互联着的路由器、交换机
>
> 网络的网络(通过网桥连接的多个网络)

- 接入网、物理媒体

> 有线或无线通信链路
>
> 将网络边缘接入网络核心的链路



#### 网络边缘

##### 采用网络设施的面向连接服务 （TCP协议

辨析:

> 面向连接，网络核心不知道连接状态，只在端系统中维护
>
> 有连接，网络核心中的节点同时维护。

目标：在端系统之间传输数据

握手：数据传输之前做好准备，两个通信主机之间为**连接建立状态**

TCP-传输控制协议

- Internet上面向连接的服务

TCP服务

- 可靠地、按顺序地传送数据 ： 确认和重传
- 流量控制： 发送方不会淹没接收方
- 拥塞控制：当网络拥塞时，发送方降低发送速率

> 使用TCP的应用： HTTP(Web)  FTP(文件传送)  Telnet(远程登录)  SMTP(email)

##### 采用基础设施的无连接服务 （UDP协议

目标： 在端系统之间传输数据

无连接服务

UDP-用户数据协议

- 无连接
- 不可靠数据传输
- 无流量控制
- 无拥塞控制

> 使用UDP的应用： 流媒体、远程会议、DNS、Internet电话



#### 网络核心

定义：路由器的网状网络

- 电(线)路交换：为每个呼叫预留一条专有电路，如电话网

  > 节点间的通信带宽分解成小片：
  >
  > 频分复用  FDM
  >
  > 时分复用  TDM
  >
  > 波分复用  WDM

  - 独享资源，不共享
  - 一旦呼叫建立就能保证性能
  - 如果没有数据发送，被分配的资源会被浪费
  - 通常被传统的电话网络采用

- 分组交换：具有很强的共享性

  - 将要传送的数据分成一个个单位(packet)

    - 特殊时分复用，链路资源
    - 统计多路复用，分组没有固定的模式

  - 将分组从一个路由器传送到相邻路由器(hop)，一段段最终从源端传到目标端

  - 每段采用链路**最大传输能力**(最大带宽)

  - 以分组为单位存储-转发方式packet-switch  分组每次移动一跳(hop)

    - 转发之前，节点必须收**到整个分组**
    - 延迟比线路交换要大
    - 存在不确定的排队时间

  - 排队和延迟

    - 如果到达速率>链路的输出速率

      分组将会排队，等待传输

    - 如果路由器的缓存用完，分组将会被抛弃 

##### 网络核心的关键功能

- **路由**

  决定分组采用的源到目标的路径

- **转发**

  将分组从路由器输入链路转移到输出链路



##### 数据报(datagram)的工作原理

- 通信之前，无需建立起一个连接，有数据就传输
- 每个分组都独立路由(路径不一样，可能会失序)
- 路由器根据分组的目标地址进行路由



##### 虚电路(virtual circuit)的工作原理

- 在分组交换网络上的两个或者多个端站点间的链路



#### 接入网和物理媒体

###### 住宅接入网络

> 有线接入(双绞线、同轴电缆、光纤、电力接入)

###### 单位接入网络

> Ethernet 以太网

##### 无线接入网络

> 无线LANS 从端系统到无线路由器
>
> 广域无线接入 (4G  5G  LTE) 由电信运行商提供

###### 专用接入网络



### Internet结构

##### ISP(互联网服务提供商)

帮用户接入internet

1. 第一层ISP
   - 直接与其他第一层ISP相连
   - 与大量的第二层ISP相连
2. 第二层ISP (通常是**区域I**SP)
   - 与一个或者多个第一层ISPs相连
   - 也可能与其他第二层ISPs
3. 第三层ISP(local)
   - 接入网

互联网络的结构：**网络**的**网络**

> N个ISPs  全连接，需要O(N*N)

将每个接入ISP都连接到全局ISP(全局范围内覆盖)？

- 客户ISPs和提供者ISPs有经纪合约
- 竞争：全局ISP是有利可为的**业务**，会有竞争者
- 通过ISP直接合作完成**业务**扩展，存在对等互联的结算关系(peer link)
- 完成业务细分

##### ICP 互联网内容提供商

内容提供商在全球部署自己的数据中心机房，通过专线连接。(如微软、谷歌等)



#### 协议层次和服务模型

> 协议的实现，借助于下层提供的服务。实现协议的目的，为了给上层提供更好的服务

PDU：协议数据单元  上层来的SDU通过层间接口后，加上本层的头部信息， 形成本层的PDU

**层次化实现复杂网络功能：**

- 将网络复杂的功能分成功能明确的**层次**，每一层实现了其中一个或一 组**功能**，功能中有其上层可以使用的功能：**服务** 
- 本层协议实体相互交互执行本层的**协议动作**，目的是**实现本层功能**， 通过接口**为上层提供更好的服务**  
- 在实现本层协议的时候，直接**利用了下层所提供的服务**  
- 本层的服务：借助下层服务实现的本层协议实体之间交互带来的新功能（上层可以利用的）+更下层所提供的服务

服务访问点(SAP): 下层向上层用户提供服务时用于区分要服务用户的信息。

原语(primitive)：上层通过SAP向下层告知需要使用什么服务

 

服务类型：

- 面向连接的服务   (TCP)
- 无连接的服务      (UDP)



#### Internet协议栈

- **应用层**  网络应用
  - 为人类用户或者其他应用进程提供网络应用服务。**应用报文**的交互 （message）
  - 协议：FTP , SMTP, HTTP,  DNS
- **传输层**  主机之间的数据传输，单位是**报文段** (message segment)
  - 在网络层提供的端到端通信基础上，细分为**进程到进程**。
  - 将不可靠通信变成可靠通信。
  - 协议：TCP,  UDP
- **网络层**  为(**分组**)从源到目的选择路由  (packet)
  - **主机主机**之间的通信，端到端通信，不可靠 （E2E）
  - 协议： **IP, 路由协议**
- **链路层**  相邻网络节点间的数据传输    (frame)
  - 2个相邻2点的通信，点到点通信，传输以**帧**为单位的数据。可靠或不可靠
- **物理层** 在物理线路上传送bit   (bit)



## 应用层

- **传输层的服务模型**
  - socket API

#### 应用进程架构模式

- **客户-服务器模式 (C-S client-server)**

  - 服务器：
    - 一直运行
    - 固定的IP地址和周知的端口号
    - 扩展性差
  - 客户端：
    - 主动和服务器通信
    - 与互联网有间歇性的连接
    - 可能是动态IP地址
    - **不直接**与其他客户端通信

- **对等模式 (P2P)**

  - 没有一直运行的服务器
  - 任意端系统之间可以进行通信
  - 每个节点既是客户端又是服务器
  - 参与的主机间歇性连接且可以改变IP地址 --难以管理

- **混合体：C-S 和P2P结构**

  #### **内容分发网络 (CDN)**

  #### 网络应用实例：互联网流行的应用协议

  - **HTTP**
  - **FTP**
  - **SMTP/POP3/IMAP**
  - **DNS**

应用进程

- 客户端进程：发起通信的进程

- 服务器进程：等待通信的进程



**应用层向传输层传递数据：**

​	TCP socket：

- TCP服务，两个进程之间的通信需要之前建立连接
  - 两个进程通信会持续一段时间，通信关系稳定
- 可用一个整数表示两个应用实体之间的通信关系，为**本地**标示
- 穿过层间接口的信息量最小
- TCP socket： 源IP  源端口    目标IP  目标端口  代表了会话关系。同一个进程可能有不同的socket
- 套接字是4元组的一个具有**本地意义**的标示

UDP socket：

- UDP服务，两个进程之间通信不需要建立连接
  - 每个报文独立传输
  - 前后报文可能给不同的分布式进程
- 因此，只能用一个整数表示本应用实体的**本地**标示
  - 因为这个报文可能传给另一个分布式进程
- 穿过层间接口的信息大小最小
- UDP socket： 本IP  本端口
- 传输报文时，必须要提供对方的IP， port
  - 接收报文时，传输层需要上传对方的IP port 

#### 应用层协议

定义了运行在不同端系统上的应用进程如何相互交换报文：

- 交换的**报文类型** 请求和应答报文
- 各种报文类型的**语法**，报文中各个字段及其描述
- 字段的**语义**：即字段取值的含义
- 进程何时，如何发送报文及对报文进行响应的**规则**

> 对等层的应用进程在通信的过程中应当遵守的规则集合
>
> 仅仅是应用的一个组成部分

**应用实体：与网络交互有关的，遵守协议的应用部分**

传输层向上层提供的服务指标：延迟、吞吐量、可靠性(数据丢失率)、安全性

 **TCP:** 

1. 可提供服务

- 可靠的传输服务：

- 流量控制

  发送方不会淹没接收方

- 拥塞控制

  当网络出现拥塞时，能抑制发送方

2. 不能提供的服务

- 时间保证、最小吞吐保证和安全

3. 面向连接



**UDP：**

- 不可靠数据传输

**不**提供的服务：

可靠，流量控制，拥塞控制，时间，带宽保证，建立连接。



##### 安全TCP

SSL:安全套接字层

- 在TCP之上实现，提供加密的TCP连接
- 私密性
- 数据完整性
- 端到端的鉴别

SSL是运行在应用层的，库采用SSL库，使用TCP通信

SSL socket API

- 应用通过API将明文交给socket，SSL将其加密在互联网上传输



### HTTP

 **Web**:web包含一个基本的HTML文件，该基本HTML文件又包含若干对象的引用(链接)

URL：统一资源定位器。通过URL实现对每个对象的引用。

- 访问协议、用户名、口令字、端口

格式

- Prot://user:psw@www.someSchool.edu.cn:port/someDept/pic.gif

- 如：http://www.baidu.com/

  

**HTTP:超文本传输协议**

- 是Web的应用层协议

- C-S模式

  - 客户：请求，接收和显示web对象的浏览器
  - 服务器：对请求进行响应，发送对象的web服务器

  

**使用TCP**：

- 客户端发起一个与服务器的TCP连接(**建立套接字**)，端口号为80
- 服务器接受客户端的TCP连接
- HTTP客户端与Web服务器交换HTTP报文
- TCP连接关闭

> HTTP是无状态的，服务器不维护关于客户的任何信息。

**HTTP连接**：

- 非持久HTTP
  - 最多只有一个对象在TCP上连接上发送
  - 下载多个对象需要多个TCP连接
  - HTTP/1.0
- 持久HTTP
  - 多个对象可以在一个（客户端和服务器之间）TCP连接上传输
    - 非流水方式的持久HTTP
      - 客户端只能在收到前一个相应后才能发出新的请求
      - 每个引用对象花费一个RTT(round trip time)
    - 流水方式的持久HTTP
      - 客户端遇到一个引用对象就立即产生请求
      - 所有引用（小）对象只花费一个RTT是有可能的
  - HTTP/1.1
    - 默认使用流水方式

**HTTP请求报文**

- **请求**
  - 请求报文
    - 请求行(GET,POST,HEAD命令)
    - 首部行
    - 换行回车符 表示报文结束
  - 方法
    - GET 请求指定页面信息并返回响应主体，一般用于数据读取
    -  POST 向指定资源提交数据，请求服务器处理
    - HEAD（要求服务器在响应报文中不包含请求对象entity body）
    - PUT   向指定资源位置上传其最新内容
    - DELETE （删除URL字段规定的文件）
- **响应**
  - HTTP响应报文
    - 状态行(协议版本，状态码，相关状态信息)
    - 首部行 (Connection、Date等信息)
    - 数据，如请求的HTML文件

> **HTTP的首部有哪些？**
>
> - 通用首部：表示一些通用信息，如date表示报文创建时间
> - 请求首部：请求报文独有，如cookie、If-Modified-Since
> - 响应首部：响应报文独有，如set-cookie、Last-Modified
> - 实体首部：描述实体部分，如allow用来描述可执行的请求方法、content-type描述主体类型、content-Encoding描述主体的编码方式

> **get和post有什么区别**
>
> get和post本质上就是TCP链接，并无差别，但由于HTTP的规定和浏览器、服务器的限制，导致它们在应用过程中有一些不同：
>
> - get参数通过URL传递；post放在request body中
> - get请求在URL中传递的参数有长度限制；post没有（HTTP协议未规定，是因为浏览器和服务器的限制）
> - get请求只能进行URL编码；post请求有多种编码方式
> - get请求参数会被完整保留在浏览历史记录里；post中的参数不会被保留
> - get产生一个TCP数据包；post产生两个TCP数据包
> - 对于get请求，浏览器将http header和data一并发送，服务器响应200 OK；对于post请求，浏览器先发送header，服务器响应100 Continue，浏览器再发送data，服务器响应200 OK
> - 缓存方面：get请求类似于查找的过程，用户获取数据，可以不用每次都与数据库连接，所以可以使用缓存；post请求一般做的是修改和删除工作，必须与数据库交互，所以不能使用缓存

**一、HTTP常见状态码**

按第一个数字分类：1表示信息，2表示成功，3表示重定向，4表示客户端错误，5表示服务器错误

|          状态码           |                             含义                             |
| :-----------------------: | :----------------------------------------------------------: |
|          200 OK           |               请求成功。一般用于get和post请求                |
|   301 Moved Permanently   |    永久移动。请求的信息已经被移动到新的URI，会返回新的URI    |
|         302 Found         |      临时移动。资源只是临时被移动，客户端继续使用原URI       |
|     304 Not Modified      | 未修改。所请求的资源未修改，服务器返回此状态码，不会返回任何资源 |
|      400 Bad Request      | 客户端请求的语法错误，服务器无法理解（产生原因：前端提交的数据在后台找不到与之相对应的实体） |
|     401 Unauthorized      |                     当前请求需要用户验证                     |
|       403 Forbidden       |                服务器已经收到请求，但拒绝执行                |
|       404 Not Found       |               服务器无法根据用户的请求找到资源               |
| 500 Internal Server Error |                 服务器内部错误，无法完成请求                 |



### CDN内容分发网络

> - 在CDN节点中存储内容的多个拷贝
> - 用户从CDN中请求内容，重定向到最近的拷贝，请求内容。

构建在现有网络基础之上的**智能虚拟网络**，依靠部署在各地的**边缘服务器**，通过中心平台的负载均衡、内容分发、调度等功能模块，使客户端向最近的(跳数最少的)CDN缓存节点请求资源,降低网络拥塞，提高响应速率的。

- enter deep

  将CDN服务器深入到许多接入网(如local ISP)

  - 更接近用户，数量多，离用户近，但管理困难
  - 如akami，有1700多个CDN

- bring home

  部署在少数(10个左右)关键位置，如将服务器安装于POP(入网点)附近

  - 采用租用线路将服务器簇连接起来
  - Limelight

用户从源服务器获得manifest告示文件，客户端请求对应资源时，通过manifest文件，c完成重定向，向最近的缓存节点请求资源。

**CDN运行在应用层，处于网络的边缘**

> over the top



## 传输层

### 传输层工作原理

#### 多路复用

#### 可靠数据传输

#### 流量控制

#### 拥塞控制

### TCP





### UDP